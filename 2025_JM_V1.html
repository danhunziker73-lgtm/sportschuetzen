(function(){
  var API_URL="https://jahresmeisterschaft-muhen.dan-hunziker73.workers.dev";
  var fN = v => isFinite(Number(v)) ? Number(v).toFixed(2) : "0.00";

  window.toggle = id => {
    var e = document.getElementById(id);
    if(e) e.style.display = e.style.display === "table-row" ? "none" : "table-row";
  };

  function renderLiga(ligaNr, raw) {
    var html = `<div class="liga"><h2>Liga ${ligaNr}</h2><table><thead><tr><th class="col-rang">Rang</th><th>Name</th><th class="col-jg">Jg.</th><th class="col-total">Total</th><th class="col-zusatz">Zusatz</th></tr></thead><tbody>`;
    
    (raw || []).forEach((t, i) => {
      var id = `l${ligaNr}_${i}`, au = t.auswaerts || [], sP = 'style="display:inline-block;min-width:100px;text-align:left"';
      
      html += `<tr class="clickable" onclick="toggle('${id}')"><td><b>${t.rang||"-"}</b></td><td>${t.name||"-"}</td><td>${t.jahrgang||"-"}</td><td><b>${fN(t.total)}</b></td><td>${au.length?au.length+' Auswärts':''}</td></tr>
      <tr id="${id}" class="details"><td colspan="5"><div class="detail-grid">
        <div class="detail-box"><h4>Meisterschaft <span ${sP}>Pkt (%)</span></h4><ul>${(t.schiessen||[]).map(s => `<li><span class="item-name">${s.name}</span><span class="item-dots"></span><span ${sP}>${s.punkte} <small>(${fN(s.prozent)}%)</small></span></li>`).join('')}</ul></div>
        <div class="detail-box"><h4>Mannschaft <span ${sP}>Pkt</span></h4><ul>${[1,2,3,4,5,6,7].map(r => {
          var m = (t.mannschaft||[]).find(x => (x.runde||"").includes("#"+r));
          return `<li><span class="item-name">Runde ${r}</span><span class="item-dots"></span><span ${sP}>${m?m.punkte:'-'}</span></li>`;
        }).join('')}</ul></div>
        <div class="detail-box"><h4>Auswärts <span ${sP}>Pkt</span></h4><ul>${au.map(a => `<li><span class="item-name">${a.name}</span><span class="item-dots"></span><span ${sP}>${a.punkte}</span></li>`).join('')}</ul></div>
      </div></td></tr>`;
    });
    return html + '</tbody></table></div>';
  }

  var xhr = new XMLHttpRequest();
  xhr.open("GET", API_URL, true);
  xhr.onload = () => {
    var d = JSON.parse(xhr.responseText);
    document.getElementById("content").innerHTML = renderLiga(1, d.liga1) + renderLiga(2, d.liga2);
  };
  xhr.send();
})();
