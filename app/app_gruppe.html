<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gruppenmeisterschaft</title>
    <style>
        /* Dein Original-Styling */
        body { font-family: Arial, sans-serif; background: #f4f6f8; margin: 0; padding: 15px; }
        h1 { margin-bottom: 5px; color: #0f3c5c; }
        .subtitle { color: #666; margin-bottom: 15px; }
        .table-wrapper { overflow-x: auto; margin-bottom: 20px; }
        table { width: 100%; min-width: 400px; border-collapse: collapse; background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid #e0e0e0; }
        th { background: #0f3c5c; color: white; }
        td.team { font-weight: bold; text-align: left; cursor: pointer; white-space: normal; word-wrap: break-word; max-width: 180px; color: #0f3c5c; }
        td.cell { background: #fafafa; cursor: pointer; }
        td.cell:hover { background: #e6eef5; }
        .detail { margin-top: 5px; background: #f9f9f9; padding: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); display: none; }
        .player { display: grid; grid-template-columns: 1fr auto auto auto; gap: 12px; padding: 6px 0; border-bottom: 1px solid #eee; align-items: center; }
        .name { display: flex; align-items: center; gap: 8px; }
        .stellung { font-size: 12px; font-weight: bold; padding: 3px 10px; border-radius: 12px; white-space: nowrap; }
        .liegend { background: #e3f0ff; color: #1e5dbf; }
        .kniend { background: #e6f6ec; color: #1f7a3a; }
        .total { font-weight: bold; text-align: right; margin-top: 10px; font-size: 16px; }
        @media (max-width: 768px) { th, td { padding: 8px; font-size: 14px; } h1 { font-size: 20px; } }
    </style>
</head>
<body>

    <h1 id="main-title">Gruppenmeisterschaft</h1>
    <div class="subtitle" id="sub-title">Lade Daten...</div>
    <div id="overview"></div>

<script>
    // --- KONFIGURATION ---
    const WORKER_URL = "https://gruppe.dan-hunziker73.workers.dev";
    const urlParams = new URLSearchParams(window.location.search);
    const selectedYear = urlParams.get('jahr') || 'aktuell'; 
    const YEAR_LABEL = (selectedYear === 'aktuell') ? "Aktuell" : selectedYear;

    let raw = [];
    let teams = [];

    // Daten laden beim Start
    window.onload = loadData;

    async function loadData() {
        document.getElementById('main-title').textContent = `Gruppenmeisterschaft ${YEAR_LABEL}`;
        document.getElementById('sub-title').textContent = `Übersicht ${YEAR_LABEL} – auf Punkte klicken für Details`;

        // Anfrage an den neuen Worker
        const url = `${WORKER_URL}?type=gruppe&jahr=${selectedYear}`;
        
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP-Fehler: ${response.status}`);
            
            const json = await response.json();
            
            // Mapping der Google-Struktur aus dem Worker
            const rows = json.table ? json.table.rows : [];
            
            raw = rows.map(r => {
                let row = { 
                    name: r.c[0]?.v || "", 
                    stellung: r.c[1]?.v || "" 
                };
                for(let i=1; i<=3; i++){
                    row[`r${i}Team`] = r.c[(i-1)*3+2]?.v || "";
                    row[`r${i}Pkt1`] = Number(r.c[(i-1)*3+3]?.v) || 0;
                    row[`r${i}Pkt2`] = Number(r.c[(i-1)*3+4]?.v) || 0;
                    row[`r${i}Sum`]  = row[`r${i}Pkt1`] + row[`r${i}Pkt2`];
                }
                return row;
            });

            // Teams extrahieren und sortieren
            teams = [...new Set(raw.flatMap(r => 
                Object.keys(r).filter(k => k.includes("Team")).map(k => r[k]).filter(Boolean)
            ))].sort();
            
            buildTable();
            
        } catch (e) {
            console.error("Ladefehler:", e);
            document.getElementById("overview").innerHTML = 
                `<p style='color:red'>Fehler beim Laden über Worker: ${e.message}</p>`;
        }
    }

    function buildTable(){
        let html = `<div class="table-wrapper"><table><tr><th></th><th>R1</th><th>R2</th><th>R3</th></tr>`;

        teams.forEach((team, index) => {
            html += `<tr><td class="team">${team}</td>`;
            for(let r=1; r<=3; r++){
                const sum = raw.filter(p => p[`r${r}Team`] === team).reduce((a, b) => a + b[`r${r}Sum`], 0);
                html += `<td class="cell" onclick="toggleDetail('${team.replace(/'/g,"\\'")}', ${r}, ${index})">${sum || "–"}</td>`;
            }
            html += `</tr><tr id="detail-${index}"><td colspan="4"><div id="detail-div-${index}" class="detail"></div></td></tr>`;
        });

        html += `</table></div>`;
        document.getElementById("overview").innerHTML = html;
    }

    function toggleDetail(team, round, index){
        const div = document.getElementById(`detail-div-${index}`);
        if(div.style.display === "block"){
            div.style.display = "none";
            return;
        }

        const list = raw.filter(p => p[`r${round}Team`] === team);
        let total = 0;
        let html = `<h3>${team} – Runde ${round}</h3>`;
        
        list.forEach(p => {
            const p1 = p[`r${round}Pkt1`];
            const p2 = p[`r${round}Pkt2`];
            const sum = p1 + p2;
            total += sum;
            const cls = p.stellung.toLowerCase() === "liegend" ? "liegend" : "kniend";
            html += `
                <div class="player">
                    <div class="name">${p.name}<span class="stellung ${cls}">${p.stellung}</span></div>
                    <div>${p1}</div>
                    <div>${p2}</div>
                    <div><strong>${sum}</strong></div>
                </div>`;
        });
        
        html += `<div class="total">Gesamt: ${total}</div>`;
        div.innerHTML = html;
        div.style.display = "block";
    }
</script>
</body>
</html>
