<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jahresmeisterschaft</title>

<style>
:root{
  --primary:#0f3a5d;
  --bg:#f6f7f8;
  --text:#333;
  --accent:#e74c3c;
}

body{
  font-family:system-ui,-apple-system,sans-serif;
  background:var(--bg);
  margin:0;
  padding:15px;
  color:var(--text);
}

h1{margin:0 0 5px}
.subtitle{color:#666;font-size:.9rem;margin-bottom:20px;text-align:center}

.liga{margin-bottom:30px}

table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
  border-radius:8px;
  overflow:hidden;
  table-layout:fixed;
}

thead{background:var(--primary);color:#fff}

th,td{
  padding:12px 8px;
  border-bottom:1px solid #eee;
  vertical-align:top;
}

.col-rang{width:45px}
.col-name{
  width:auto;
  font-weight:600;
  white-space:normal;
  line-height:1.2;
}
.col-total{width:75px;text-align:right;font-variant-numeric:tabular-nums}
.col-zusatz{width:85px;text-align:right}

.clickable{cursor:pointer}
.clickable:active{background:#f0f4f8}

.status-label{
  display:block;
  font-size:.6rem;
  font-weight:bold;
  text-transform:uppercase;
}

.text-auf{color:#27ae60}
.text-ab{color:#c0392b}

.aufsteiger{border-left:4px solid #2ecc71}
.absteiger{border-left:4px solid #e74c3c}

.badge-auswaerts{
  background:#e8f5e9;
  color:#2e7d32;
  padding:2px 5px;
  border-radius:4px;
  font-size:.7rem;
  font-weight:bold;
  white-space:nowrap;
}

/* --- Details / Karten --- */

.details{display:none;background:#fdfdfd}
.details td{padding:0}

.detail-grid{
  display:grid;
  grid-template-columns:1fr;
  gap:15px;
  padding:15px;
  border-top:2px solid var(--primary);
}

@media(min-width:768px){
  .detail-grid{
    grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
  }
}

.detail-box h4{
  display:flex;
  justify-content:space-between;
  margin:0 0 8px;
  padding-bottom:5px;
  border-bottom:1px solid #ddd;
  color:var(--primary);
  font-size:.9rem;
}

.two-col{list-style:none;padding:0;margin:0}
.two-col li{
  display:flex;
  justify-content:space-between;
  padding:4px 0;
  font-size:.85rem;
}

.item-right{
  font-weight:600;
  font-variant-numeric:tabular-nums;
}

.prz-small{font-size:.8rem;color:#666;margin-left:4px}

.is-streich{
  color:var(--accent);
  text-decoration:line-through;
  opacity:.75;
}

.streich-info{
  margin-top:10px;
  padding:8px;
  background:#fff0f0;
  border-left:4px solid var(--accent);
  font-size:.85rem;
  font-weight:600;
}

/* --- MAX Tooltip --- */

.max-hint{
  font-size:.6em;
  vertical-align:super;
  color:rgba(255,255,255,.7);
  cursor:pointer;
}

.tooltip{
  position:fixed;
  background:#fff;
  padding:6px 10px;
  font-size:.75rem;
  border-radius:6px;
  box-shadow:0 4px 12px rgba(0,0,0,.15);
  opacity:0;
  pointer-events:none;
  transition:.15s;
  z-index:9999;
}

.tooltip.show{opacity:1}
</style>
</head>

<body>

<h1 id="dyn-title">Jahresmeisterschaft</h1>
<div class="subtitle">Tippen Sie auf einen Schützen für Details</div>
<div id="content">Lade Daten…</div>
<div id="tooltip" class="tooltip"></div>

<script>
(function(){

/* --- Jahr / API --- */
const params=new URLSearchParams(location.search);
const year=params.get("jahr")||"aktuell";
document.getElementById("dyn-title").textContent=
  "Jahresmeisterschaft "+(year==="aktuell"?"Aktuell":year);

const API_URL="https://jahresmeisterschaft-muhen.dan-hunziker73.workers.dev?jahr=current";

/* --- Helpers --- */
const fmt=v=>isFinite(v)?Number(v).toFixed(2):"0.00";
const arr=v=>Array.isArray(v)?v:[];

let openRow=null;

/* --- Toggle: immer nur eins offen --- */
window.toggle=id=>{
  if(openRow && openRow!==id){
    const prev=document.getElementById(openRow);
    if(prev) prev.style.display="none";
  }
  const el=document.getElementById(id);
  if(!el) return;
  el.style.display=(el.style.display==="table-row")?"none":"table-row";
  openRow=(el.style.display==="table-row")?id:null;
};

/* --- Render Liga --- */
function renderLiga(ligaNr,data){
  let html=`<div class="liga"><h2>Liga ${ligaNr}</h2>
  <table><thead><tr>
  <th class="col-rang">Rang</th>
  <th class="col-name">Name</th>
  <th class="col-total">Total <span class="max-hint">max</span></th>
  <th class="col-zusatz">Zusatz</th>
  </tr></thead><tbody>`;

  arr(data).forEach((t,i)=>{
    const id=`l${ligaNr}_${i}`;
    const au=arr(t.auswaerts);
    let cls="",label="";
    if(ligaNr===1 && i>=data.length-2){cls="absteiger";label='<span class="status-label text-ab">Abstieg</span>'}
    if(ligaNr===2 && i<2){cls="aufsteiger";label='<span class="status-label text-auf">Aufstieg</span>'}

    html+=`
<tr class="clickable ${cls}" onclick="toggle('${id}')">
  <td><b>${t.rang||"-"}</b>${label}</td>
  <td class="col-name">${t.name||"-"}</td>
  <td class="col-total"><b>${fmt(t.total)}</b></td>
  <td class="col-zusatz">${au.length?`<span class="badge-auswaerts">${au.length} Ausw.</span>`:""}</td>
</tr>`;

    /* --- Details --- */
    html+=`<tr id="${id}" class="details"><td colspan="4">
    <div class="detail-grid">`;

    /* Meisterschaft */
    let used=false, streich=Number(t.streichresultat_prz)||0;
    html+=`<div class="detail-box"><h4><span>Meisterschaft</span><span>Pkt (%)</span></h4><ul class="two-col">`;
    arr(t.schiessen).forEach(s=>{
      const p=Number(s.prozent);
      const isStreich=!used && streich>0 && Math.abs(p-streich)<0.0001;
      if(isStreich) used=true;
      html+=`<li class="${isStreich?"is-streich":""}">
        <span>${s.name||"-"}</span>
        <span class="item-right">${s.punkte||"-"} <span class="prz-small">(${fmt(p)}%)</span></span>
      </li>`;
    });
    html+=`</ul>${streich>0?`<div class="streich-info">Streichresultat: ${fmt(streich)}%</div>`:""}</div>`;

    /* Mannschaft */
    html+=`<div class="detail-box"><h4><span>Mannschaft</span><span>Pkt</span></h4><ul class="two-col">`;
    arr(t.mannschaft).forEach((m,j)=>{
      html+=`<li><span>Runde ${j+1}</span><span class="item-right">${m.punkte||"-"}</span></li>`;
    });
    html+=`</ul></div>`;

    /* Auswärtsschiessen */
    html+=`<div class="detail-box"><h4><span>Auswärtsschiessen</span><span>Pkt</span></h4>`;
    if(au.length){
      html+=`<ul class="two-col">`;
      au.forEach(a=>{
        html+=`<li><span>${a.name||"-"}</span><span class="item-right">${a.punkte||"-"}</span></li>`;
      });
      html+=`</ul>`;
    } else {
      html+=`<p style="color:#999;font-size:.85rem">Keine Resultate vorhanden.</p>`;
    }
    html+=`</div>`;

    html+=`</div></td></tr>`;
  });

  return html+`</tbody></table></div>`;
}

/* --- Fetch --- */
fetch(API_URL)
.then(r=>r.json())
.then(d=>{
  document.getElementById("content").innerHTML=
    renderLiga(1,d.liga1)+renderLiga(2,d.liga2);

  /* MAX Tooltip */
  const tip=document.getElementById("tooltip");
  document.querySelectorAll(".max-hint").forEach(el=>{
    el.addEventListener("click",e=>{
      e.stopPropagation();
      const r=el.getBoundingClientRect();
      tip.textContent="Maximum: "+d.max;
      tip.style.left=r.left+r.width/2+"px";
      tip.style.top=r.top+"px";
      tip.classList.add("show");
    });
  });
  document.addEventListener("click",()=>tip.classList.remove("show"));
})
.catch(()=>{
  document.getElementById("content").textContent="Fehler beim Laden.";
});

})();
</script>

</body>
</html>



