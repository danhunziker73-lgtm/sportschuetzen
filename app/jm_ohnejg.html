<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jahresmeisterschaft</title>
<style>
:root{
  --primary:#0f3a5d;
  --bg:#f6f7f8;
  --text:#333;
  --accent:#e74c3c;
}

body{
  font-family:system-ui,-apple-system,sans-serif;
  background:var(--bg);
  margin:0;
  padding:15px; /* Etwas weniger Padding für Mobile */
  color:var(--text);
}

.subtitle{color:#666; font-size: 0.85rem; margin-bottom:20px; text-align:center;}
.liga{margin-bottom:30px}
h2 { color: var(--primary); border-bottom: 2px solid #ddd; padding-bottom: 5px; font-size: 1.2rem; margin-top: 10px;}

table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
  border-radius:8px;
  overflow:hidden;
  table-layout:fixed; /* Verhindert das Springen der Spalten */
}

thead{background:var(--primary);color:#fff}

th,td{
  padding:12px 8px;
  text-align:left;
  border-bottom:1px solid #eee;
}

/* Platzverteilung */
.col-rang { width: 45px; } /* Kompakt für Rangnummer */
.col-name { width: auto; font-weight: 600; white-space: normal; line-height: 1.2; } /* Name kriegt den Rest */
.col-total { width: 75px; text-align: right; } /* Rechtsbündig für Zahlen */
.col-zusatz { width: 85px; text-align: right; }

.clickable{cursor:pointer}
.clickable:active{background:#f0f4f8}

.details{display:none;background:#fdfdfd}
.details td{white-space:normal; padding: 0;}

.detail-grid{
  display:grid;
  grid-template-columns: 1fr;
  gap:15px;
  padding:15px;
  border-top:2px solid var(--primary);
}

.detail-box h4{
  display:flex;
  justify-content:space-between;
  margin:0 0 8px;
  padding-bottom:5px;
  border-bottom:1px solid #ddd;
  color:var(--primary);
  font-size: 0.9rem;
}

.two-col{ list-style:none; padding:0; margin:0; }
.two-col li{
  display:flex;
  justify-content:space-between;
  padding:4px 0;
  font-size: 0.85rem;
}

.item-right{ font-weight:600; font-variant-numeric:tabular-nums; }
.is-streich{ color:var(--accent); text-decoration:line-through; opacity:.7; }

.badge-auswaerts{
  background:#e8f5e9;
  color:#2e7d32;
  padding:2px 5px;
  border-radius:4px;
  font-size:.7rem;
  font-weight:bold;
  white-space: nowrap;
}

.status-label{ font-size:.6rem; font-weight:bold; text-transform:uppercase; display:block; }
.text-auf{color:#27ae60} .text-ab{color:#c0392b}
.aufsteiger{border-left:4px solid #2ecc71;}
.absteiger{border-left:4px solid #e74c3c;}

/* max Hint */
.max-hint { font-size: .6em; vertical-align: super; color: rgba(255,255,255,0.7); }
</style>
</head>

<body>
<div class="subtitle">Tippen Sie auf einen Schützen für Details</div>
<div id="content">Lade Daten…</div>

<script>
(function(){
  var API_URL="https://jahresmeisterschaft-muhen.dan-hunziker73.workers.dev?jahr=current";

  function formatNum(v){
    var n=Number(v);
    return isFinite(n)?n.toFixed(2):"0.00";
  }

  window.toggle=function(id){
    var el=document.getElementById(id);
    if(el) el.style.display=(el.style.display==="table-row")?"none":"table-row";
  };

  function renderLiga(ligaNr,raw){
    var teilnehmer=Array.isArray(raw)?raw:[];
    var html='<div class="liga"><h2>Liga '+ligaNr+'</h2><table><thead><tr>'+
      '<th class="col-rang">Rang</th>'+
      '<th class="col-name">Name</th>'+
      '<th class="col-total">Total <span class="max-hint">max</span></th>'+
      '<th class="col-zusatz">Zusatz</th>'+
      '</tr></thead><tbody>';

    for(var i=0;i<teilnehmer.length;i++){
      var t=teilnehmer[i]||{};
      var id="l"+ligaNr+"_"+i;

      var statusClass="", statusLabel="";
      if(ligaNr===1 && i>=teilnehmer.length-2) { statusClass="absteiger"; statusLabel='<span class="status-label text-ab">Abstieg</span>'; }
      if(ligaNr===2 && i<2) { statusClass="aufsteiger"; statusLabel='<span class="status-label text-auf">Aufstieg</span>'; }

      html+='<tr class="clickable '+statusClass+'" onclick="toggle(\''+id+'\')">'+
        '<td><b>'+(t.rang||"-")+'</b>'+statusLabel+'</td>'+
        '<td class="col-name">'+(t.name||"-")+'</td>'+
        '<td class="col-total"><b>'+formatNum(t.total)+'</b></td>'+
        '<td class="col-zusatz">'+(t.auswaerts?.length?'<span class="badge-auswaerts">'+t.auswaerts.length+' Ausw.</span>':"")+'</td>'+
        '</tr>';

      // Details (angepasst ohne Jahrgang)
      html+='<tr id="'+id+'" class="details"><td colspan="4"><div class="detail-grid">';
      
      // Meisterschaft
      html+='<div class="detail-box"><h4><span>Meisterschaft</span><span>%</span></h4><ul class="two-col">';
      (t.schiessen||[]).forEach(function(s){
          var isStreich = (t.streichresultat_prz && Math.abs(s.prozent - t.streichresultat_prz) < 0.0001);
          html+='<li class="'+(isStreich?'is-streich':'')+'"><span>'+s.name+'</span><span class="item-right">'+formatNum(s.prozent)+'</span></li>';
      });
      html+='</ul></div>';

      // Mannschaft
      html+='<div class="detail-box"><h4><span>Mannschaft</span><span>Pkt</span></h4><ul class="two-col">';
      (t.mannschaft||[]).forEach(function(m, idx){
          html+='<li><span>Runde '+(idx+1)+'</span><span class="item-right">'+(m.punkte||"-")+'</span></li>';
      });
      html+='</ul></div>';

      html+='</div></td></tr>';
    }
    return html+'</tbody></table></div>';
  }

  fetch(API_URL).then(r=>r.json()).then(d=>{
      document.getElementById("content").innerHTML=renderLiga(1,d.liga1)+renderLiga(2,d.liga2);
  }).catch(e=>{
      document.getElementById("content").innerHTML="Fehler beim Laden.";
  });
})();
</script>
</body>
</html>
