<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Standblatt hochladen – Jahresmeisterschaft</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --primary:#0f3a5d;
  --primary-dark:#0a2a45;
  --bg:#ffffff;
  --card:#f9fafb;
  --text:#1f2937;
  --text-light:#6b7280;
  --border:#d1d5db;
  --error:#f87171;
  --success:#22c55e;
}
body{font-family:Inter,sans-serif;background:var(--bg);margin:0;padding:2rem 1rem}
.container{max-width:520px;margin:0 auto}
.card{background:var(--card);padding:2rem;border-radius:16px}
.form-group{margin-bottom:1.6rem;position:relative}
label{position:absolute;top:.8rem;left:1rem;font-size:.75rem;color:var(--text-light)}
input,select{width:100%;padding:1.2rem 1rem .4rem;border:1px solid var(--border);border-radius:8px}
button{width:100%;padding:1.1rem;background:var(--primary);color:#fff;border:none;border-radius:10px;font-size:1.05rem;font-weight:600}
.error{display:none;color:var(--error);font-size:.85rem;margin-top:.4rem}
#preview{max-width:100%;max-height:160px;display:none;margin-top:1rem}
</style>
</head>

<body>
<div class="container">
<div class="card">
<form id="uploadForm">

<div class="form-group">
  <select id="name" required>
    <option value="" disabled selected>Deinen Namen auswählen *</option>
  </select>
  <label>Dein Name *</label>
  <div class="error" id="nameError">Bitte Namen auswählen</div>
</div>

<div class="form-group">
  <input type="file" id="foto" accept="image/jpeg,image/png" required>
  <label>Foto Standblatt *</label>
  <img id="preview">
</div>

<div class="form-group">
  <input type="number" id="erzielt" required>
  <label>Erzielte Punkte *</label>
</div>

<div class="form-group">
  <input type="number" id="maximal" required>
  <label>Maximal *</label>
</div>

<button type="submit" id="submitBtn">Standblatt senden</button>
</form>
</div>
</div>

<script>
const WORKER_URL = "https://github-dropdown-refresh.dan-hunziker73.workers.dev/";
let teilnehmer = [];

/* -------------------------
   Teilnehmer laden
-------------------------- */
async function loadTeilnehmer() {
  const res = await fetch(
    "https://raw.githubusercontent.com/danhunziker73-lgtm/sportschuetzen/main/teilnehmer.json?t=" + Date.now()
  );
  teilnehmer = await res.json();

  const select = document.getElementById("name");
  teilnehmer.forEach(p => {
    const opt = document.createElement("option");
    opt.value = String(p.lizenz || p.id);   // STRING!
    opt.textContent = p.name;
    select.appendChild(opt);
  });
}
loadTeilnehmer();

/* -------------------------
   Preview
-------------------------- */
document.getElementById("foto").addEventListener("change", e => {
  const f = e.target.files[0];
  if (!f) return;
  const r = new FileReader();
  r.onload = ev => {
    const img = document.getElementById("preview");
    img.src = ev.target.result;
    img.style.display = "block";
  };
  r.readAsDataURL(f);
});

/* -------------------------
   Submit
-------------------------- */
document.getElementById("uploadForm").addEventListener("submit", async e => {
  e.preventDefault();

  const selectedId = String(document.getElementById("name").value);
  const erz = document.getElementById("erzielt").value;
  const max = document.getElementById("maximal").value;
  const fotoFile = document.getElementById("foto").files[0];

  const user = teilnehmer.find(
    t => String(t.lizenz || t.id) === selectedId   // ✅ FIX
  );

  if (!user) {
    alert("Teilnehmer nicht gefunden – bitte Seite neu laden");
    return;
  }

  const reader = new FileReader();
  reader.onload = async () => {

    const payload = {
      action: "upload_standblatt",
      lizenz: selectedId,
      vorname: user.vorname,
      nachname: user.nachname,
      erzielt: erz,
      maximal: max,
      foto: reader.result
    };

    const res = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const json = await res.json();
    if (json.success) {
      alert("✔ Erfolgreich gesendet");
      e.target.reset();
      document.getElementById("preview").style.display = "none";
    } else {
      alert("Fehler: " + (json.error || "unbekannt"));
    }
  };

  reader.readAsDataURL(fotoFile);
});
</script>
</body>
</html>
