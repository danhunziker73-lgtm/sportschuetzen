<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Jahresmeisterschaft 2025</title>

<style>
:root{
  --primary:#0f3a5d;
  --bg:#f6f7f8;
  --text:#333;
  --accent:#e74c3c;
}

body{
  font-family:system-ui,-apple-system,sans-serif;
  background:var(--bg);
  margin:0;
  padding:20px;
  color:var(--text);
}

h1{margin-bottom:5px}
.subtitle{color:#666;margin-bottom:30px}

.liga{margin-bottom:40px}

table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
  border-radius:8px;
  overflow:hidden;
  table-layout:fixed;
}

thead{background:var(--primary);color:#fff}

th,td{
  padding:12px 15px;
  text-align:left;
  border-bottom:1px solid #eee;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

.col-rang{width:60px}
.col-jg{width:80px}
.col-total{width:100px}
.col-zusatz{width:120px}

.clickable{cursor:pointer}
.clickable:hover{background:#f0f4f8}

.details{display:none;background:#fdfdfd}
.details td{white-space:normal}

.detail-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
  gap:25px;
  padding:20px;
  border-top:2px solid var(--primary);
}

.detail-box h4{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  margin:0 0 10px;
  padding-bottom:5px;
  border-bottom:2px solid #ddd;
  color:var(--primary);
}

.two-col{
  list-style:none;
  padding:0;
  margin:0;
}

.two-col li{
  display:flex;
  justify-content:space-between;
  align-items:baseline;
  padding:4px 0;
}

.item-right{
  font-weight:600;
  font-variant-numeric:tabular-nums;
  white-space:nowrap;
}

.prz-small{
  font-size:.85rem;
  color:#666;
  margin-left:4px;
}

.badge-auswaerts{
  background:#e8f5e9;
  color:#2e7d32;
  padding:2px 6px;
  border-radius:4px;
  font-size:.75rem;
  font-weight:bold;
}

.status-label{
  font-size:.65rem;
  font-weight:bold;
  text-transform:uppercase;
  display:block;
  margin-top:2px;
}

.text-auf{color:#27ae60}
.text-ab{color:#c0392b}

.aufsteiger{border-left:5px solid #2ecc71;background:#fafffa}
.absteiger{border-left:5px solid #e74c3c;background:#fffaf9}

.streich-info{
  background:#fff0f0;
  padding:8px;
  border-radius:4px;
  border-left:4px solid var(--accent);
  margin-top:15px;
  font-size:.9rem;
  font-weight:600;
}

.is-streich{
  color:var(--accent);
  text-decoration:line-through;
  opacity:.7;
}
</style>
</head>

<body>
<h1>Jahresmeisterschaft 2025</h1>
<div class="subtitle">Klicken Sie auf einen Schützen für die detaillierte Auswertung</div>
<div id="content">Lade Daten…</div>

<script>
(function(){
  var API_URL = "https://jahresmeisterschaft-muhen.dan-hunziker73.workers.dev?jahr=2025";


  function formatNum(v){
    var n=Number(v);
    return isFinite(n)?n.toFixed(2):"0.00";
  }

  function safeArray(v){
    return Object.prototype.toString.call(v)==="[object Array]"?v:[];
  }

  window.toggle=function(id){
    var el=document.getElementById(id);
    if(!el)return;
    el.style.display=(el.style.display==="table-row")?"none":"table-row";
  };

  function renderLiga(ligaNr,raw){
    var teilnehmer=safeArray(raw);
    var html='<div class="liga"><h2>Liga '+ligaNr+'</h2><table><thead><tr>'+
      '<th class="col-rang">Rang</th><th>Name</th><th class="col-jg">Jg.</th>'+
      '<th class="col-total">Total</th><th class="col-zusatz">Zusatz</th>'+
      '</tr></thead><tbody>';

    for(var i=0;i<teilnehmer.length;i++){
      var t=teilnehmer[i]||{};
      var sch=safeArray(t.schiessen);
      var ma=safeArray(t.mannschaft);
      var au=safeArray(t.auswaerts);
      var streichPrz=Number(t.streichresultat_prz);
      var used=false;

      var statusClass="",statusLabel="";
      if(ligaNr===1&&i>=teilnehmer.length-2){
        statusClass="absteiger";
        statusLabel='<span class="status-label text-ab">Abstieg</span>';
      }
      if(ligaNr===2&&i<2){
        statusClass="aufsteiger";
        statusLabel='<span class="status-label text-auf">Aufstieg</span>';
      }

      var id="liga"+ligaNr+"_"+i;

      html+='<tr class="clickable '+statusClass+'" onclick="toggle(\''+id+'\')">'+
        '<td><b>'+(t.rang??"-")+'</b>'+statusLabel+'</td>'+
        '<td>'+(t.name??"-")+'</td>'+
        '<td>'+(t.jahrgang??"-")+'</td>'+
        '<td><b>'+formatNum(t.total)+'</b></td>'+
        '<td>'+(au.length?'<span class="badge-auswaerts">'+au.length+' Auswärts</span>':"")+'</td>'+
        '</tr>';

      html+='<tr id="'+id+'" class="details"><td colspan="5"><div class="detail-grid">';

      /* Meisterschaft */
      html+='<div class="detail-box"><h4><span>Meisterschaft</span><span>Pkt (%)</span></h4><ul class="two-col">';
      for(var j=0;j<sch.length;j++){
        var s=sch[j]||{};
        var p=Number(s.prozent);
        var isStreich=isFinite(streichPrz)&&!used&&Math.abs(p-streichPrz)<0.0001&&streichPrz>0;
        if(isStreich)used=true;

        html+='<li class="'+(isStreich?'is-streich':'')+'">'+
          '<span>'+(s.name||"-")+'</span>'+
          '<span class="item-right">'+
            (s.punkte||"-")+
            ' <span class="prz-small">('+formatNum(p)+'%)</span>'+
          '</span>'+
        '</li>';
      }
      html+='</ul>'+(streichPrz>0?'<div class="streich-info">Streichresultat: '+formatNum(streichPrz)+'%</div>':"")+'</div>';

      /* Mannschaft */
      html+='<div class="detail-box"><h4><span>Mannschaft</span><span>Pkt</span></h4><ul class="two-col">';
      for(j=0;j<ma.length;j++){
        html+='<li>'+
          '<span>Runde '+(j+1)+'</span>'+
          '<span class="item-right">'+(ma[j].punkte||"-")+'</span>'+
        '</li>';
      }
      html+='</ul></div>';

      /* Auswärtsschiessen */
      html+='<div class="detail-box"><h4><span>Auswärtsschiessen</span><span>Pkt</span></h4>';
      if(au.length){
        html+='<ul class="two-col">';
        for(j=0;j<au.length;j++){
          html+='<li>'+
            '<span>'+(au[j].name||"-")+'</span>'+
            '<span class="item-right">'+(au[j].punkte||"-")+'</span>'+
          '</li>';
        }
        html+='</ul>';
      } else {
        html+='<p style="color:#999;font-size:.9rem">Keine Resultate vorhanden.</p>';
      }
      html+='</div>';

      html+='</div></td></tr>';
    }

    return html+'</tbody></table></div>';
  }

  var xhr=new XMLHttpRequest();
  xhr.open("GET",API_URL,true);
  xhr.onreadystatechange=function(){
    if(xhr.readyState!==4)return;
    if(xhr.status!==200){
      document.getElementById("content").innerHTML='<div class="error-box">Fehler beim Laden</div>';
      return;
    }
    var data=JSON.parse(xhr.responseText);
    document.getElementById("content").innerHTML=
      renderLiga(1,data.liga1)+renderLiga(2,data.liga2);
  };
  xhr.send();
})();
</script>
</body>
</html>
