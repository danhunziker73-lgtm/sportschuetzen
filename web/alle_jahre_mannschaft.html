<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mannschaftsmeisterschaft</title>

<style>
/* Styles bleiben identisch für konsistentes Design */
body { font-family: Arial, sans-serif; background: #f4f6f8; margin: 0; padding: 15px; }
h1 { margin-bottom: 5px; }
.subtitle { color: #666; margin-bottom: 15px; }
.table-wrapper { overflow-x: auto; margin-bottom: 20px; }
table { width: 100%; min-width: 600px; border-collapse: collapse; background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
th, td { padding: 10px; text-align: center; border-bottom: 1px solid #e0e0e0; }
th { background: #0f3c5c; color: white; }
td.team { font-weight: bold; text-align: left; white-space: normal; word-wrap: break-word; max-width: 180px; color: #0f3c5c; }
td.cell { cursor: pointer; background: #fafafa; }
td.cell:hover { background: #e6eef5; }
.detail { margin-top: 5px; background: #f9f9f9; padding: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); display: none; }
.player { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #eee; }
.total { font-weight: bold; text-align: right; margin-top: 10px; font-size: 16px; }
@media (max-width: 768px) { th, td { padding: 8px; font-size: 14px; } h1 { font-size: 20px; } }
</style>

<script>
const SHEET_ID = "1VuOv6b8r5m1g_9ZidPR3OPZ7YIwLUm6dYLC9nKmC2mE";

// 1. Jahr aus der URL extrahieren (z.B. ?jahr=2025)
const urlParams = new URLSearchParams(window.location.search);
const selectedYear = urlParams.get('jahr') || 'aktuell'; 

// 2. Tabellenblatt-Name festlegen
const SHEET_NAME = (selectedYear === 'aktuell') 
    ? "Aktuell_Mannschaft" 
    : `${selectedYear}_Mannschaft`;

let raw = [];
let teams = [];

window.onload = () => {
    const displayTitle = (selectedYear === 'aktuell') ? "Aktuell" : selectedYear;
    document.querySelector('h1').textContent = `Mannschaftsmeisterschaft ${displayTitle}`;
    document.querySelector('.subtitle').textContent = `Übersicht ${displayTitle} – auf Punkte klicken für Details`;
    loadData();
};

async function loadData() {
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}&tqx=out:json`;
    
    try {
        const response = await fetch(url);
        const text = await response.text();
        
        // JSON-Daten aus dem Google-Wrapper extrahieren
        const start = text.indexOf('{');
        const end = text.lastIndexOf('}') + 1;
        const jsonResponse = JSON.parse(text.substring(start, end));
        const data = jsonResponse.table;

        raw = data.rows.map(r => {
            let rowObj = { name: r.c[0] ? r.c[0].v : "" };
            for(let i=1; i<=7; i++) {
                rowObj[`r${i}Team`] = r.c[(i-1)*2+1] ? r.c[(i-1)*2+1].v : "";
                rowObj[`r${i}Pkt`]  = r.c[(i-1)*2+2] ? Number(r.c[(i-1)*2+2].v) : 0;
            }
            return rowObj;
        });

        teams = [...new Set(raw.flatMap(r => 
            Object.keys(r).filter(k => k.includes("Team")).map(k => r[k]).filter(Boolean)
        ))].sort();

        buildTable();
    } catch (error) {
        console.error("Fehler:", error);
        document.getElementById("overview").innerHTML = 
            `<p style='color:red'>Fehler beim Laden des Blatts "${SHEET_NAME}". Bitte prüfen Sie, ob es im Google Sheet existiert.</p>`;
    }
}

function buildTable() {
    let html = `<div class="table-wrapper"><table><tr><th></th>`;
    for(let r=1; r<=7; r++) html += `<th>R${r}</th>`;
    html += `</tr>`;

    teams.forEach((team, index) => {
        html += `<tr><td class="team">${team}</td>`;
        for(let r=1; r<=7; r++) {
            const sum = raw.filter(p => p[`r${r}Team`] === team).reduce((a, b) => a + (b[`r${r}Pkt`] || 0), 0);
            html += `<td class="cell" onclick="toggleDetail('${team}', ${r}, ${index})">${sum || "–"}</td>`;
        }
        html += `</tr><tr id="detail-${index}"><td colspan="8"><div id="detail-div-${index}" class="detail"></div></td></tr>`;
    });

    html += `</table></div>`;
    document.getElementById("overview").innerHTML = html;
}

function toggleDetail(team, round, index) {
    const div = document.getElementById(`detail-div-${index}`);
    if(div.style.display === "block") {
        div.style.display = "none";
        return;
    }

    const list = raw.filter(p => p[`r${round}Team`] === team);
    let total = 0;
    let html = `<h3>${team} – Runde ${round}</h3>`;
    list.forEach(p => {
        const pts = p[`r${round}Pkt`] || 0;
        total += pts;
        html += `<div class="player"><div>${p.name}</div><div>${pts}</div></div>`;
    });
    html += `<div class="total">Total: ${total}</div>`;
    div.innerHTML = html;
    div.style.display = "block";
}
</script>
</head>
<body>
<h1>Mannschaftsmeisterschaft</h1>
<div class="subtitle">Übersicht – auf Punkte klicken für Details</div>
<div id="overview">Lade Daten...</div>
</body>
</html>
