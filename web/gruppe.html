<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gruppenmeisterschaft</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f6f8; margin: 0; padding: 15px; }
        h1 { margin-bottom: 5px; color: #0f3c5c; }
        .subtitle { color: #666; margin-bottom: 15px; }
        .table-wrapper { overflow-x: auto; margin-bottom: 20px; }
        table { width: 100%; min-width: 400px; border-collapse: collapse; background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid #e0e0e0; }
        th { background: #0f3c5c; color: white; }
        td.team { font-weight: bold; text-align: left; color: #0f3c5c; max-width: 180px; word-wrap: break-word; }
        td.cell { background: #fafafa; cursor: pointer; }
        td.cell:hover { background: #e6eef5; }
        .detail { margin-top: 5px; background: #f9f9f9; padding: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); display: none; }
        .player { display: grid; grid-template-columns: 1fr auto auto auto; gap: 12px; padding: 6px 0; border-bottom: 1px solid #eee; align-items: center; }
        .stellung { font-size: 12px; font-weight: bold; padding: 3px 10px; border-radius: 12px; }
        .liegend { background: #e3f0ff; color: #1e5dbf; }
        .kniend { background: #e6f6ec; color: #1f7a3a; }
        .total { font-weight: bold; text-align: right; margin-top: 10px; font-size: 16px; }
    </style>
</head>
<body>
    <h1 id="main-title">Gruppenmeisterschaft</h1>
    <div class="subtitle" id="sub-title">Lade Daten...</div>
    <div id="overview"></div>

<script>
    const SHEET_ID = "1VuOv6b8r5m1g_9ZidPR3OPZ7YIwLUm6dYLC9nKmC2mE";
    const urlParams = new URLSearchParams(window.location.search);
    const selectedYear = urlParams.get('jahr') || 'aktuell'; 
    const SHEET_NAME = (selectedYear === 'aktuell') ? "Aktuell_Gruppe" : `${selectedYear}_Gruppe`;

    let raw = [];
    let teams = [];

    window.onload = () => {
        const displayYear = (selectedYear === 'aktuell') ? "Aktuell" : selectedYear;
        document.getElementById('main-title').textContent = `Gruppenmeisterschaft ${displayYear}`;
        document.getElementById('sub-title').textContent = `Übersicht ${displayYear} – auf Punkte klicken für Details`;
        loadData();
    };

    async function loadData() {
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}&tqx=out:json`;
        try {
            const response = await fetch(url);
            const text = await response.text();
            const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
            const data = json.table;

            raw = data.rows.map(r => {
                let obj = { name: r.c[0]?.v || "", stellung: r.c[1]?.v || "" };
                for(let i=1; i<=3; i++) {
                    obj[`r${i}Team`] = r.c[(i-1)*3+2]?.v || "";
                    obj[`r${i}P1`] = Number(r.c[(i-1)*3+3]?.v) || 0;
                    obj[`r${i}P2`] = Number(r.c[(i-1)*3+4]?.v) || 0;
                    obj[`r${i}Sum`] = obj[`r${i}P1`] + obj[`r${i}P2`];
                }
                return obj;
            });
            teams = [...new Set(raw.flatMap(r => Object.keys(r).filter(k => k.includes("Team")).map(k => r[k]).filter(Boolean)))].sort();
            buildTable();
        } catch (e) {
            document.getElementById("overview").innerHTML = "<p style='color:red'>Fehler beim Laden.</p>";
        }
    }

    function buildTable() {
        let html = `<div class="table-wrapper"><table><tr><th></th><th>R1</th><th>R2</th><th>R3</th></tr>`;
        teams.forEach((team, index) => {
            html += `<tr><td class="team">${team}</td>`;
            for(let r=1; r<=3; r++) {
                const sum = raw.filter(p => p[`r${r}Team`] === team).reduce((s, b) => s + b[`r${r}Sum`], 0);
                html += `<td class="cell" onclick="toggleDetail('${team.replace(/'/g, "\\'")}', ${r}, ${index})">${sum || "–"}</td>`;
            }
            html += `</tr><tr id="detail-${index}"><td colspan="4"><div id="detail-div-${index}" class="detail"></div></td></tr>`;
        });
        document.getElementById("overview").innerHTML = html + `</table></div>`;
    }

    function toggleDetail(team, round, index) {
        const div = document.getElementById(`detail-div-${index}`);
        if(div.style.display === "block") { div.style.display = "none"; return; }
        const list = raw.filter(p => p[`r${round}Team`] === team);
        let total = 0, html = `<h3>${team} – R${round}</h3>`;
        list.forEach(p => {
            const s = p[`r${round}Sum`]; total += s;
            const cls = p.stellung.toLowerCase() === "liegend" ? "liegend" : "kniend";
            html += `<div class="player"><div>${p.name} <span class="stellung ${cls}">${p.stellung}</span></div><div>${p[`r${round}P1`]}</div><div>${p[`r${round}P2`]}</div><div><strong>${s}</strong></div></div>`;
        });
        div.innerHTML = html + `<div class="total">Gesamt: ${total}</div>`;
        div.style.display = "block";
    }
</script>
</body>
</html>
